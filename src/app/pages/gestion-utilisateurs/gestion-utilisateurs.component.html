<div class="container">
  <aside class="sidebar">
    <app-sidebar></app-sidebar>
  </aside>
  
  <main class="main-content">
    <div class="card">
      <!-- Header -->
      <div class="header">
        <h1>Gestion des Utilisateurs</h1>
        <div class="header-buttons">
          <button class="btn-delete" (click)="deleteSelectedUsers()">Supprimer sélectionnés</button>
          <button class="btn btn-add" (click)="openModal('addModal')">
            <i class="fas fa-plus"></i> Ajouter
          </button>

          <button class="btn-toggle" (click)="blockMultipleUsers()">Bloquer/Débloquer sélectionnés</button>


        </div>
      </div>

      <!-- Search Bar -->
      <div class="search-section">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input 
            type="text" 
            [(ngModel)]="searchTerm"
            (input)="onSearch()"
            placeholder="Rechercher par Prénom, Email, Matricule..." 
            class="search-input"
          />
        </div>
      </div>

      <!-- Table -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>
                <input type="checkbox" 
                       [checked]="allSelected"
                       (change)="toggleAllSelection()"/>
              </th>
              <th>Matricule</th>
              <th>Prénom et Nom</th>
              <th>Email</th>
              <th>Téléphone</th>
              <th>Rôle</th>
              <th>Status</th>
              <th>Actions</th>
              <th>Assignation</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUtilisateurs">
              <td>
                <input type="checkbox" [(ngModel)]="user.selected"/>
              </td>
              <td>{{user.matricule}}</td>
              <td>{{user.prenom}} {{user.nom}}</td>
              <td>{{user.email}}</td>
              <td>{{user.telephone}}</td>
              <td>{{user.role}}</td>
              <td>
                <span [class]="'status ' + (user.status === 'actif' ? 'status-active' : 'status-inactive')">
                  {{user.status}}
                </span>
              </td>
              <td>
                <div class="actions">
                  <button class="btn-action edit" (click)="openModal('editModal', user)">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn-action view" (click)="openModal('viewModal', user)">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn-action delete" (click)="openModal('deleteModal', user)">
                    <i class="fas fa-trash"></i>
                  </button>
                  <button class="btn-action block" (click)="toggleBlockUser(user)" title="Cliquez pour {{ user.status === 'actif' ? 'archiver' : 'désarchiver' }} l'utilisateur">
                    <i class="fas" [ngClass]="user.status === 'actif' ? 'fa-lock' : 'fa-unlock'"></i>
                  </button>
                </div>
              </td>
              <td>
                <button class="btn-assign" (click)="openModal('assignModal', user)">
                  <i class="fas fa-user-plus"></i> Assigner
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
    </div>
  </main>
</div>

<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close" (click)="closeModal('viewModal')">&times;</span>
    <h2><i class="fas fa-user"></i> Détails de l'Utilisateur</h2>

    <p><strong>Matricule :</strong> {{ selectedUser?.matricule }}</p>
    <p><strong>Nom :</strong> {{ selectedUser?.nom }}</p>
    <p><strong>Prénom :</strong> {{ selectedUser?.prenom }}</p>
    <p><strong>Email :</strong> {{ selectedUser?.email }}</p>
    <p><strong>Téléphone :</strong> {{ selectedUser?.telephone }}</p>
    <p><strong>Rôle :</strong> {{ selectedUser?.role }}</p>

    <button (click)="closeModal('viewModal')" class="btn btn-close">Fermer</button>
  </div>
</div>


<!-- Modals -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <span class="close" (click)="closeModal('addModal')">&times;</span>
    <h2><i class="fas fa-user-plus"></i> Ajouter un Utilisateur</h2>
    
    <form (ngSubmit)="addUser()" #userForm="ngForm">
      <div class="form-group">
        <label>Prenom :</label>
        <input type="text" [(ngModel)]="newUser.prenom" name="prenom" class="input-field" required>
        <div *ngIf="errors['prenom']" class="error">{{ errors['prenom'] }}</div>
      </div>

      <div class="form-group">
        <label>Nom :</label>
        <input type="text" [(ngModel)]="newUser.nom" name="nom" class="input-field" required>
        <div *ngIf="errors['nom']" class="error">{{ errors['nom'] }}</div>
      </div>

      <div class="form-group">
        <label>Email :</label>
        <input type="email" [(ngModel)]="newUser.email" name="email" class="input-field" required>
        <div *ngIf="errors['email']" class="error">{{ errors['email'] }}</div>
      </div>

      <div class="form-group">
        <label>Téléphone :</label>
        <input type="text" [(ngModel)]="newUser.telephone" name="telephone" class="input-field" required>
        <div *ngIf="errors['telephone']" class="error">{{ errors['telephone'] }}</div>
      </div>

      <div class="form-group">
        <label>Rôle :</label>
        <select [(ngModel)]="newUser.role" name="role" (change)="onRoleChange()" class="select-field" required>
          <option value="" disabled selected>Sélectionnez un rôle</option>
          <option value="admin">admin</option>
          <option value="client">client</option>
          <option value="pompiste">pompiste</option>
        </select>
        <div *ngIf="errors['role']" class="error">{{ errors['role'] }}</div>
      </div>

      <!-- Champ carburant visible uniquement si le rôle est client -->
      <div *ngIf="newUser.role === 'client'" class="form-group">
        <label>Carburant :</label>
        <select [(ngModel)]="newUser.carburant" name="carburant" class="select-field" required>
          <option value="" disabled selected>Sélectionnez un carburant</option>
          <option value="essence">Essence</option>
          <option value="petrole">Pétrole</option>
          <option value="gazoile">Gazoile</option>
        </select>
        <div *ngIf="errors['carburant']" class="error">{{ errors['carburant'] }}</div>
      </div>

      <div class="form-group" *ngIf="newUser.role === 'client'">
        <label>Montant Dû :</label>
        <input type="number" [(ngModel)]="newUser.montantDu" name="montantDu" class="input-field" min="0" required>
        <div *ngIf="errors['montantDû']" class="error">{{ errors['montantDû'] }}</div>
      </div>

      <button type="submit" class="btn btn-add">Ajouter</button>
    </form>
  </div>
</div>




<!-- MODAL D'ÉDITION DE L'UTILISATEUR -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" (click)="closeModal('editModal')">&times;</span>
    <h2><i class="fas fa-user-edit"></i> Modifier l'Utilisateur</h2>
    
    <input *ngIf="selectedUser" type="text" [(ngModel)]="selectedUser.matricule" disabled class="input-field">

    <label>Prénom :</label>
    <input *ngIf="selectedUser" type="text" [(ngModel)]="selectedUser.prenom" class="input-field">
    <div *ngIf="errors['prenom']" class="error">{{ errors['prenom'] }}</div>

    <label>Nom :</label>
    <input *ngIf="selectedUser" type="text" [(ngModel)]="selectedUser.nom" class="input-field">
    <div *ngIf="errors['nom']" class="error">{{ errors['nom'] }}</div>

    <label>Email :</label>
    <input *ngIf="selectedUser" type="email" [(ngModel)]="selectedUser.email" class="input-field">
    <div *ngIf="errors['email']" class="error">{{ errors['email'] }}</div>

    <label>Téléphone :</label>
    <input *ngIf="selectedUser" type="text" [(ngModel)]="selectedUser.telephone" class="input-field">
    <div *ngIf="errors['telephone']" class="error">{{ errors['telephone'] }}</div>

    <label>Rôle :</label>
    <select *ngIf="selectedUser" [(ngModel)]="selectedUser.role" class="select-field">
        <option value="admin">Admin</option>
        <option value="client">Client</option>
        <option value="pompiste">Pompiste</option>
    </select>
    <div *ngIf="errors['role']" class="error">{{ errors['role'] }}</div>

    <button *ngIf="selectedUser" (click)="editUser(selectedUser)" class="btn btn-edit">Modifier</button>
  </div>
</div>

<!-- MODAL DE SUCCÈS -->
<div id="successModal" class="modal">
  <div class="modal-content success">
    <span class="close" (click)="closeModal('successModal')">&times;</span>
    <h2><i class="fas fa-check-circle"></i> Succès</h2>
    <p>{{ modalMessage }}</p>
    <button (click)="closeModal('successModal')" class="btn btn-success">OK</button>
  </div>
</div>

<!-- MODAL D'ERREUR -->
<div id="errorModal" class="modal">
  <div class="modal-content error">
    <span class="close" (click)="closeModal('errorModal')">&times;</span>
    <h2><i class="fas fa-exclamation-circle"></i> Erreur</h2>
    <p>{{ modalMessage }}</p>
    <button (click)="closeModal('errorModal')" class="btn btn-error">Fermer</button>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content">
      <span class="close" (click)="closeModal('deleteModal')">&times;</span>
      <h2><i class="fas fa-user-times"></i> Confirmer la Suppression</h2>
      <p>Êtes-vous sûr de vouloir supprimer cet utilisateur ?</p>
      <button (click)="confirmDeleteUser()">Oui</button>
      <button (click)="closeModal('deleteModal')">Non</button>
  </div>
</div>


<div id="assignModal" class="modal">
  <div class="modal-content">
      <span class="close" (click)="closeModal('assignModal')">&times;</span>
      <h2><i class="fas fa-user-plus"></i> Assigner une Carte</h2>
      <label>Code Carte :</label>
      <input type="text" [(ngModel)]="assignCardCode" class="input-field">
      <button (click)="selectedUser && assignCard(selectedUser)" class="btn btn-assign">Assigner</button>
      <button (click)="closeModal('assignModal')" class="btn btn-cancel">Annuler</button>
  </div>
</div>
